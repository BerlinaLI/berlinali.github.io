<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>我刮刮卡获得 你也快来刮！</title>
<link href="https://fonts.googleapis.com/css?family=Alfa+Slab+One" rel="stylesheet">
<style type="text/css">
*{
  font-family: 'Alfa Slab One', cursive;
}

body {
  padding: 0;
  margin: 0;
  background-color:#FFD700;

}

.title{ 
  width:100%;
  height:400px;
  background: red; /* For browsers that do not support gradients */
  /* Safari 5.1 to 6.0 */
  background: -webkit-repeating-linear-gradient(red, yellow 10%, green 20%);
  /* Opera 11.1 to 12.0 */
  background: -o-repeating-linear-gradient(red, yellow 10%, green 20%);
  /* Firefox 3.6 to 15 */
  background: -moz-repeating-linear-gradient(red, yellow 10%, green 20%);
  /* Standard syntax */
  background: repeating-linear-gradient(red, yellow 10%, green 20%);
}

.faceemoji{
  z-index:1;
  width:150px;
  height:150px;
  text-align: center;
  margin:0px auto;
  padding:10px 0;
  display:block;
}

h1{  
  z-index: 2;
  margin: 0; 
  text-align: center;
  padding: 0px 0 10px;
  font-size: 100px;
  text-shadow: 3px 2px red;
  position: relative;
  display:block;
  font-size: 5em;
  color: white;
  letter-spacing: 0.0625em;
  animation: drop-shadows;
  animation-duration: 3s;
  animation-iteration-count: infinite;
  animation-fill-mode: both;
}

@keyframes drop-shadows {
  0% {
    text-shadow: -1px 0 0 cadetblue, 0px 0 0 #5b989a, 0px 0 0 #5d9b9d, 0px 0 0 cadetblue;
  }
  25% {
    text-shadow: -1px 0 0 cadetblue, -2px 0 0 #5b989a, -3px 0 0 #599596, -4px 0 0 #579193, -5px 0 0 #568e90, -6px 0 0 #548b8d, -7px 0 0 #52888a, -8px 0 0 #508586, -9px 0 0 #4e8283, -10px 0 0 #4c7e80, -11px 0 0 #4a7b7d, -12px 0 0 #48787a, -13px 0 0 #467576, -14px 0 0 #447273, -15px 0 0 #436f70, -16px 0 0 #416b6d, -17px 0 0 #3f686a, -18px 0 0 #3d6566, -19px 0 0 #3b6263, -20px 0 0 #395f60, -21px 0 0 #375c5d, -22px 0 0 #35585a, -23px 0 0 #335556, -24px 0 0 #315253, -25px 0 0 #304f50, -26px 0 0 #2e4c4d, -27px 0 0 #2c494a, -28px 0 0 #2a4646, -29px 0 0 #284243, -30px 0 0 #263f40;
    transform: rotateY(25deg);
  }
  75% {
    text-shadow: -1px 0 0 cadetblue, 2px 0 0 #5b989a, 3px 0 0 #599596, 4px 0 0 #579193, 5px 0 0 #568e90, 6px 0 0 #548b8d, 7px 0 0 #52888a, 8px 0 0 #508586, 9px 0 0 #4e8283, 10px 0 0 #4c7e80, 11px 0 0 #4a7b7d, 12px 0 0 #48787a, 13px 0 0 #467576, 14px 0 0 #447273, 15px 0 0 #436f70, 16px 0 0 #416b6d, 17px 0 0 #3f686a, 18px 0 0 #3d6566, 19px 0 0 #3b6263, 20px 0 0 #395f60, 21px 0 0 #375c5d, 22px 0 0 #35585a, 23px 0 0 #335556, 24px 0 0 #315253, 25px 0 0 #304f50, 26px 0 0 #2e4c4d, 27px 0 0 #2c494a, 28px 0 0 #2a4646, 29px 0 0 #284243, 30px 0 0 #263f40;
    transform: rotateY(-25deg);
  }
  100% {
    text-shadow: -1px 0 0 cadetblue, 0px 0 0 #5b989a, 0px 0 0 #5d9b9d, 0px 0 0 cadetblue;
    transform: rotateY(0deg);
  }
}

.mini-slogan{
  margin:0 auto;
  padding:15px 0;
  display:block;
}

p{
  margin:0;
  color:black;
  text-shadow: 1px 1px white;
  text-align:center;
  font-size:15px;
}

p span{
  color:red;
}


</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<!-- wechat API -->
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script> 


</head>

<body>


    <div class="title">
    <img class="faceemoji" src="https://cdn.shopify.com/s/files/1/1061/1924/products/Money_Face_Emoji_b26670f3-2d57-42f5-9003-f1a1ee3257c6_large.png?v=1480481059">
   
    <div id="faceemoji"></div>

        <h1>刮刮卡</h1>
        <div class="mini-slogan">
          <strong>
          <p>老板今天开微信号疯了!!!</p>
          <p>最高奖金<span>1亿</span>美元，中奖率<span>100%</span></p>
          </strong>
        </div>
    </div>      
<script type="text/javascript">

(function(){
      
  var mousedown = false;
  var bodyStyle = document.body.style;
  bodyStyle.mozUserSelect = 'none';
  bodyStyle.webkitUserSelect = 'none';
  
  var i= 0;
  var imgGenerateSpeed = 200;
  var imgScrollSpeed = 2000; 
  var arcSize = 40; 

  var imgs = [
    'p_0.jpg',
    'p_0.jpg',
    'p_0.jpg',
    'p_0.jpg',
    'p_1.jpg'
  ];

  var hints = [
    '请在以上的刮奖区刮奖',
    '再给你一次机会刮奖',
    '不中，再给你一次机会',
    '好吧，老板说把奖放在第5个...',
    '呵呵，都说我不是骗子啦'
  ]


  function draw(i){

    if(i<5){
    //if(i<2){ 
      var canvas = ( function createCanvas() {
        var canvas = document.createElement('canvas');
        var div = document.createElement('div');
        div.appendChild(canvas);     
        document.body.appendChild(div); 
        
        canvas.id = i;
        canvas.style.backgroundColor='transparent';
        canvas.style.margin = '20px auto';
        canvas.style.display='block';
        return canvas;   
      })();

      (function initImg(canvas){
        var  img = new Image();
        img.src = imgs[i]; //i - index 
        img.addEventListener('load',function(e){
            drawScratchCard(e, canvas)
        });
      })(canvas)

      //explaination added below the scratch card  
      var p = document.createElement('p');
      p.id="status";
      p.textContent = hints[i]; 
      document.body.appendChild(p); 
   
      //jQuery scroll down feature
      if(i>0){
        jQuery('html, body').animate({
          scrollTop: jQuery("canvas#"+i).offset().top + $( "canvas" ).height()
        }, imgScrollSpeed);
      }

    }else{
      jumpToAnimation();
    }
  };

  function drawScratchCard(e, canvas){

      var img = e.target;
      var ctx;
      var w = img.width,
          h = img.height;

      canvas.width=w;
      canvas.height=h;
      canvas.style.backgroundImage='url('+img.src+')';   

      ctx=canvas.getContext('2d');
      ctx.fillStyle = 'gray';
      ctx.fillRect(0, 0, w, h);

      layer(ctx,w,h);

      ctx.globalCompositeOperation = 'destination-out';

      attachEvent(canvas, ctx)
  }

  function layer(ctx,w,h){
    ctx.fillStyle = 'gray';
    ctx.fillRect(0, 0, w, h);
  }

  function attachEvent(canvas, ctx) {
      canvas.addEventListener('touchstart', handlerEventDown.bind(mousedown));
      canvas.addEventListener('touchend', handlerEventUp.bind({canvas: canvas, ctx: ctx}));  
      canvas.addEventListener('touchmove', handlerEventMove.bind({canvas: canvas, ctx: ctx}));
 
      canvas.addEventListener('mousedown', handlerEventDown.bind(mousedown));
      canvas.addEventListener('mouseup', handlerEventUp.bind({canvas: canvas, ctx: ctx}));
      canvas.addEventListener('mousemove', handlerEventMove.bind({canvas: canvas, ctx: ctx})); 
  }


  function handlerEventDown(e){
    mousedown = this.mousedown; //question
    e.preventDefault();
    mousedown=true;
  }

  function handlerEventUp(e){
    mousedown = this.mousedown; 
    e.preventDefault();
    mousedown=false;
    //eraseAreaDetection(canvas,ctx);
  // }

  /*
  todo 
  i tried to put the code below into a function and call it in handlerEventUp but it is not working. I have passed the argument in function. Don't know what is going wrong. 
  */
  // function eraseAreaDetection(canvas,ctx){
    //if the erased area percentage is > 0.5, clear the layer and generate new one
    var imgData = this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);
    var pixelsArr= imgData.data;
    var loop = pixelsArr.length;
    var transparent = 0;

    for(var j=0; j<loop ; j+=4){
      var alpha = pixelsArr[j+3];
      if(alpha<10){
        transparent++;
      }
    }
    var erasePercentage = transparent/(loop/4);  
    var mouseAt = parseInt(e.target.id); 
    console.log("I = "+i,"mouse at = "+mouseAt,erasePercentage>.5); 
    if(i == mouseAt && erasePercentage >.5){ 


    /*todo 
    if the if statement is true, 
    action 1: 
      clear the layer(line220). Changes its color from brown to transparent.My solution below does not work. 
    action 2(finished): 
      generate a new scratch card below. 
    */

      // setTimeout(function(){
      //   console.log("action 1");
      //   this.ctx.fillStyle ='transparent';       
      // }, imgGenerateSpeed*0.1);

      setTimeout(function(){
        console.log("action 2");
        draw(mouseAt+1);
      }, imgGenerateSpeed);
      
      i++;
      return i;
    }
  }

  function handlerEventMove(e){
    e.preventDefault();
    var offsetX = this.canvas.offsetLeft,
        offsetY = this.canvas.offsetTop;
 
    if(mousedown) {
      if(e.changedTouches){
        e=e.changedTouches[e.changedTouches.length-1];
      }

      var x = (e.clientX + document.body.scrollLeft || e.pageX) - offsetX || 0,//question
          y = (e.clientY + document.body.scrollTop || e.pageY) - offsetY || 0;

      with(this.ctx) {//question
           beginPath();
           arc(x, y, arcSize, 0, Math.PI * 2);
           closePath();
           fill();
      }
    }    
  }

  function jumpToAnimation(){
    $('canvas').fadeOut("slow");
    setTimeout(function(){ 
      window.open("http://www.goodboydigital.com/pixijs/bunnymark_v3/","_self");
    }, 0);
  }


  draw(i);

    
})()


var numInTitle = 550;


$(function () {
    // 微信分享授权配置参数
    wx.config({
        appId: '${params.appId}', // 公众号唯一标识
        timestamp: '${params.timestamp}', // 时间戳
        nonceStr: '${params.nonceStr}', // 随机字符串
        signature: '${params.signature}', // 签名
        jsApiList: [
            "onMenuShareTimeline", // 分享到朋友圈
            "onMenuShareAppMessage" // 分享给朋友
        ]
    });

    wx.ready(function () {
        //发送给微信朋友
        wx.onMenuShareAppMessage({
            title: "this is "+ numInTitle + "a title", // 分享标题
            desc: "this is a desc", // 分享描述
            link: "link", // 分享链接
            imgUrl: "", // 分享图标
            type: '', // 分享类型,music、video或link，不填默认为link
            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            success: function () {
                // 用户确认分享后执行的回调函数
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });

        //分享到朋友圈
        wx.onMenuShareTimeline({
            title:"this is "+ numInTitle + "a title",
            link: "",
            imgUrl: "",
            success: function () {
            },
            cancel: function () {
            }
        });
    });
});




</script>

</body>
</html>  