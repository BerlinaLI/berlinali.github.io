<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>本刮刮卡老板决定送你一亿</title>
<style type="text/css">
.demo{width:320px; margin:10px auto 20px auto; min-height:300px;}
.msg{text-align:center; height:32px; line-height:32px; font-weight:bold; margin-top:50px}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

</head>

<body>

<script type="text/javascript">

(function(){
      
    var mousedown = false;
    var bodyStyle = document.body.style;
    bodyStyle.mozUserSelect = 'none';
    bodyStyle.webkitUserSelect = 'none';
    
    var i= 0;   

    // var $ = jQuery;

    var imgs = [
    // 'p_0.jpg','p_1.jpg'
        'http://www.iconsplace.com/icons/preview/orange/number-0-256.png',
        'http://www.iconsplace.com/icons/preview/orange/number-1-256.png', 
        'http://www.iconsplace.com/icons/preview/orange/number-2-256.png',
        'http://www.iconsplace.com/icons/preview/orange/number-3-256.png',
        'http://www.iconsplace.com/icons/preview/orange/number-4-256.png',
        'http://www.iconsplace.com/icons/preview/orange/number-5-256.png',
        'http://www.iconsplace.com/icons/preview/orange/number-6-256.png',
        'http://www.iconsplace.com/icons/preview/orange/number-7-256.png',
        'http://www.iconsplace.com/icons/preview/orange/number-8-256.png',
        'http://www.iconsplace.com/icons/preview/orange/number-9-256.png'
    ];

     
    // (function go(i) {
    //   var i = i || 0; //default operator
    //   i = +i;
    //   i = draw(i);
    //   if (i>=0) {
    //     setTimeout(go.bind(null, i), 3000) //？？？
    //   };

    // }.bind(null, 9))();   


    function draw(i){

      if(i<10){
        var canvas = ( function createCanvas() {
            var canvas = document.createElement('canvas');
            var div = document.createElement('div');
            div.appendChild(canvas);
            document.body.appendChild(div); 
            canvas.id = i;
            canvas.style.backgroundColor='transparent';
            canvas.style.margin = '10px auto 10px auto';
            return canvas;  //!!!!!   
        })();

        (function initImg(canvas){
            var  img = new Image();
            img.src = imgs[i]; //i - index 
            img.addEventListener('load',function(e){
                drawScratchCard(e, canvas)
            });

        })(canvas)
      
        //jQuery scroll down feature
        jQuery('html, body').animate({
          scrollTop: jQuery("canvas#"+i).offset().top + $( "canvas" ).height()
        }, 2000);

      }; 
    };

    function drawScratchCard(e, canvas){

        var img = e.target;
        var ctx;
        var w = img.width,
            h = img.height;

        canvas.width=w;
        canvas.height=h;
        canvas.style.backgroundImage='url('+img.src+')';

        //$( "canvas" ).fadeIn( 2000 );
        
        ctx=canvas.getContext('2d');
        ctx.fillStyle='transparent';
        ctx.fillRect(0, 0, w, h);  //why need to add such layer

        layer(ctx, w, h);
        ctx.globalCompositeOperation = 'destination-out';

        attachEvent(canvas, ctx)
    }

    function attachEvent(canvas, ctx) {

        canvas.addEventListener('touchstart', handlerEventDown.bind(mousedown));
        canvas.addEventListener('touchend', handlerEventUp.bind(mousedown));
        canvas.addEventListener('touchmove', handlerEventMove.bind({canvas: canvas, ctx: ctx}));
        canvas.addEventListener('mousedown', handlerEventDown.bind(mousedown));
        canvas.addEventListener('mouseup', handlerEventUp.bind(mousedown));
        canvas.addEventListener('mousemove', handlerEventMove.bind({canvas: canvas, ctx: ctx}));  //？？？？
    }

    function layer(ctx, w, h) {
        ctx.fillStyle = 'gray';
        ctx.fillRect(0, 0, w, h);

    }


    function handlerEventDown(e){
      mousedown = this; //？？
      e.preventDefault();
      mousedown=true;

      var mouseAt = parseInt(e.target.id); //turn string into int

      console.log("I = "+i,"mouse at = "+mouseAt);

      if(i == mouseAt){
        setTimeout(draw(mouseAt+1), 2000);
        i++;
        return i;
      }

    }

    function handlerEventUp(e){
        mousedown = this;
        e.preventDefault();
        mousedown=false;

    }

    function handlerEventMove(e){

        e.preventDefault();

         var offsetX = this.canvas.offsetLeft,
            offsetY = this.canvas.offsetTop;
     
         if(mousedown) {
             if(e.changedTouches){
                 e=e.changedTouches[e.changedTouches.length-1];
             }
             var x = (e.clientX + document.body.scrollLeft || e.pageX) - offsetX || 0,
                 y = (e.clientY + document.body.scrollTop || e.pageY) - offsetY || 0;
             with(this.ctx) {
                 beginPath()
                 arc(x, y, 10, 0, Math.PI * 2);
                 fill();
             }
        }
    }

   draw(i);

})()

</script>






</body>
</html>  